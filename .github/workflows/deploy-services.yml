name: Deploy Docker Services

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      n8n: ${{ steps.changes.outputs.n8n }}
      nextcloud: ${{ steps.changes.outputs.nextcloud }}
      sonarqube: ${{ steps.changes.outputs.sonarqube }}
      wiki: ${{ steps.changes.outputs.wiki }}
      minecraft: ${{ steps.changes.outputs.minecraft }}
      changed-services: ${{ steps.list-changes.outputs.services }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            n8n:
              - 'n8n/**'
            nextcloud:
              - 'nextcloud/**'
            sonarqube:
              - 'sonarqube/**'
            wiki:
              - 'wiki/**'
            minecraft:
              - 'minecraft/**'
      
      - name: List changed services
        id: list-changes
        run: |
          services=""
          if [ "${{ steps.changes.outputs.n8n }}" == "true" ]; then
            services="$services n8n"
          fi
          if [ "${{ steps.changes.outputs.nextcloud }}" == "true" ]; then
            services="$services nextcloud"
          fi
          if [ "${{ steps.changes.outputs.sonarqube }}" == "true" ]; then
            services="$services sonarqube"
          fi
          if [ "${{ steps.changes.outputs.wiki }}" == "true" ]; then
            services="$services wiki"
          fi
          if [ "${{ steps.changes.outputs.minecraft }}" == "true" ]; then
            services="$services minecraft"
          fi
          # Trim leading whitespace
          services=$(echo "$services" | sed 's/^ *//')
          echo "services=$services" >> $GITHUB_OUTPUT
          echo "Changed services: '$services'"

  debug:
    needs: detect-changes
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Debug output
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Changed services: '${{ needs.detect-changes.outputs.changed-services }}'"
          echo "n8n: ${{ needs.detect-changes.outputs.n8n }}"
          echo "nextcloud: ${{ needs.detect-changes.outputs.nextcloud }}"
          echo "sonarqube: ${{ needs.detect-changes.outputs.sonarqube }}"
          echo "wiki: ${{ needs.detect-changes.outputs.wiki }}"
          echo "minecraft: ${{ needs.detect-changes.outputs.minecraft }}"
          echo "Deploy condition check: ${{ github.event_name == 'push' && needs.detect-changes.outputs.changed-services != '' }}"

  deploy:
    name: Deploy Changed Services
    needs: detect-changes
    if: github.event_name == 'push' && needs.detect-changes.outputs.changed-services != ''
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy changed services
        run: |
          echo "ðŸš€ Starting deployment of changed services..."
          
          for service in ${{ needs.detect-changes.outputs.changed-services }}; do
            echo ""
            echo "ðŸ“¦ Deploying $service..."
            cd $service
            
            echo "ðŸ“‹ Current status:"
            docker compose ps || true
            
            echo "ðŸ”„ Stopping $service..."
            docker compose down || true
            
            echo "ðŸš€ Starting $service..."
            docker compose up -d
            
            echo "âœ… $service deployment completed"
            docker compose ps
            
            cd ..
          done

      - name: Show all running containers
        run: docker ps

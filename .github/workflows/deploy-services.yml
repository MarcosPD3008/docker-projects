name: Deploy Docker Services

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      n8n: ${{ steps.changes.outputs.n8n }}
      nextcloud: ${{ steps.changes.outputs.nextcloud }}
      sonarqube: ${{ steps.changes.outputs.sonarqube }}
      wiki: ${{ steps.changes.outputs.wiki }}
      minecraft: ${{ steps.changes.outputs.minecraft }}
      changed-services: ${{ steps.list-changes.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            n8n:
              - 'n8n/**'
            nextcloud:
              - 'nextcloud/**'
            sonarqube:
              - 'sonarqube/**'
            wiki:
              - 'wiki/**'
            minecraft:
              - 'minecraft/**'

      - name: List changed services
        id: list-changes
        run: |
          services=""
          [ "${{ steps.changes.outputs.n8n }}" == "true" ] && services="$services n8n"
          [ "${{ steps.changes.outputs.nextcloud }}" == "true" ] && services="$services nextcloud"
          [ "${{ steps.changes.outputs.sonarqube }}" == "true" ] && services="$services sonarqube"
          [ "${{ steps.changes.outputs.wiki }}" == "true" ] && services="$services wiki"
          [ "${{ steps.changes.outputs.minecraft }}" == "true" ] && services="$services minecraft"
          services=$(echo "$services" | sed 's/^ *//') # Trim leading space
          echo "services=$services" >> $GITHUB_OUTPUT
          echo "Changed services: '$services'"

  debug:
    needs: detect-changes 
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Debug output
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Changed services: '${{ needs.detect-changes.outputs.changed-services }}'"
          echo "n8n: ${{ needs.detect-changes.outputs.n8n }}"
          echo "nextcloud: ${{ needs.detect-changes.outputs.nextcloud }}"
          echo "sonarqube: ${{ needs.detect-changes.outputs.sonarqube }}"
          echo "wiki: ${{ needs.detect-changes.outputs.wiki }}"
          echo "minecraft: ${{ needs.detect-changes.outputs.minecraft }}"

  deploy:
    name: Deploy Changed Services
    needs: detect-changes
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy changed services
        run: |
          echo "ğŸš€ Starting deployment of changed services..."

          changed_services="${{ needs.detect-changes.outputs.changed-services }}"
          echo "ğŸ” Services to deploy: $changed_services"

          if [ -z "$changed_services" ]; then
            echo "âš ï¸ No services changed. Skipping deployment."
            exit 0
          fi

          for service in $changed_services; do
            echo ""
            echo "ğŸ“¦ Deploying $service..."
            cd "$service" || { echo "âŒ Failed to enter folder $service"; exit 1; }

            echo "ğŸ“‹ Current status:"
            docker compose ps || true

            echo "ğŸ”„ Stopping $service..."
            docker compose down || true

            echo "ğŸš€ Starting $service..."
            docker compose up -d

            echo "âœ… $service deployment completed"
            docker compose ps

            cd ..
          done

      - name: Show all running containers
        run: docker ps

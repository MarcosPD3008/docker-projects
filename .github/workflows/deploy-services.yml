name: Validate Docker Compose Files

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      n8n: ${{ steps.changes.outputs.n8n }}
      nextcloud: ${{ steps.changes.outputs.nextcloud }}
      sonarqube: ${{ steps.changes.outputs.sonarqube }}
      wiki: ${{ steps.changes.outputs.wiki }}
      minecraft: ${{ steps.changes.outputs.minecraft }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            n8n:
              - 'n8n/**'
            nextcloud:
              - 'nextcloud/**'
            sonarqube:
              - 'sonarqube/**'
            wiki:
              - 'wiki/**'
            minecraft:
              - 'minecraft/**'

  validate-compose:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate docker-compose files
        run: |
          echo "� Validating Docker Compose configurations..."
          
          if [ "${{ needs.detect-changes.outputs.n8n }}" == "true" ]; then
            echo "📋 Validating n8n..."
            cd n8n && docker compose config && cd ..
          fi
          
          if [ "${{ needs.detect-changes.outputs.nextcloud }}" == "true" ]; then
            echo "� Validating Nextcloud..."
            cd nextcloud && docker compose config && cd ..
          fi
          
          if [ "${{ needs.detect-changes.outputs.sonarqube }}" == "true" ]; then
            echo "� Validating SonarQube..."
            cd sonarqube && docker compose config && cd ..
          fi
          
          if [ "${{ needs.detect-changes.outputs.wiki }}" == "true" ]; then
            echo "� Validating Wiki..."
            cd wiki && docker compose config && cd ..
          fi
          
          if [ "${{ needs.detect-changes.outputs.minecraft }}" == "true" ]; then
            echo "� Validating Minecraft..."
            cd minecraft && docker compose config && cd ..
          fi
          
          echo "✅ All configurations are valid!"

  summary:
    needs: [detect-changes, validate-compose]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Validation Summary
        run: |
          echo "## Docker Compose Validation Summary 📋" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-compose.result }}" == "success" ]; then
            echo "✅ **All configurations validated successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Services checked:" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.detect-changes.outputs.n8n }}" == "true" ]; then
              echo "- ✅ n8n" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.detect-changes.outputs.nextcloud }}" == "true" ]; then
              echo "- ✅ Nextcloud" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.detect-changes.outputs.sonarqube }}" == "true" ]; then
              echo "- ✅ SonarQube" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.detect-changes.outputs.wiki }}" == "true" ]; then
              echo "- ✅ Wiki" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ needs.detect-changes.outputs.minecraft }}" == "true" ]; then
              echo "- ✅ Minecraft" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🚀 **Ready to deploy manually with:** \`docker compose up -d\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Validation failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above and fix any configuration issues." >> $GITHUB_STEP_SUMMARY
          fi
